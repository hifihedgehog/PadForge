<UserControl x:Class="PadForge.Views.PadPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:PadForge.ViewModels"
             xmlns:controls="clr-namespace:PadForge.Controls"
             xmlns:views="clr-namespace:PadForge.Views"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance vm:PadViewModel}"
             d:DesignHeight="700" d:DesignWidth="900">

    <UserControl.Resources>
        <!-- Style for dead zone slider groups -->
        <Style x:Key="DzLabel" TargetType="TextBlock">
            <Setter Property="Width" Value="130"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
        </Style>
        <Style x:Key="DzSlider" TargetType="Slider">
            <Setter Property="Minimum" Value="0"/>
            <Setter Property="Maximum" Value="100"/>
            <Setter Property="Width" Value="200"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="IsSnapToTickEnabled" Value="True"/>
            <Setter Property="TickFrequency" Value="1"/>
        </Style>
        <Style x:Key="DzValue" TargetType="TextBlock">
            <Setter Property="Width" Value="35"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="TextAlignment" Value="Right"/>
            <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            <Setter Property="Margin" Value="4,0,0,0"/>
        </Style>
        <Style x:Key="DzValueEdit" TargetType="TextBox">
            <Setter Property="Width" Value="40"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="TextAlignment" Value="Right"/>
            <Setter Property="Margin" Value="4,0,0,0"/>
            <Setter Property="Padding" Value="2,1"/>
        </Style>
        <Style x:Key="DzPercent" TargetType="TextBlock">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="2,0,0,0"/>
            <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <!-- Row 0: Device selector header -->
            <RowDefinition Height="Auto"/>
            <!-- Row 1: Configuration tabs -->
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- ═══════════════════════════════════════════
             ROW 0: Device Selector Header
             Selects which physical device to configure within this pad slot.
             Like x360ce's device list above the mapping grid.
             ═══════════════════════════════════════════ -->
        <Border Grid.Row="0" Padding="8" Margin="0,0,0,4"
                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal"
                            VerticalAlignment="Center" Margin="0,0,12,0">
                    <TextBlock Text="&#xE7FC;" FontFamily="Segoe MDL2 Assets"
                               FontSize="18" VerticalAlignment="Center" Margin="0,0,8,0"
                               Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                    <TextBlock Text="{Binding SlotLabel}"
                               FontSize="16" FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                </StackPanel>

                <!-- Device ComboBox: select which mapped device to configure -->
                <ComboBox Grid.Column="1"
                          ItemsSource="{Binding MappedDevices}"
                          SelectedItem="{Binding SelectedMappedDevice, Mode=TwoWay}"
                          MinWidth="250"
                          VerticalAlignment="Center">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Ellipse Width="8" Height="8" Margin="0,0,6,0"
                                         VerticalAlignment="Center">
                                    <Ellipse.Style>
                                        <Style TargetType="Ellipse">
                                            <Setter Property="Fill" Value="#FF888888"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsOnline}" Value="True">
                                                    <Setter Property="Fill" Value="#FF4CAF50"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Ellipse.Style>
                                </Ellipse>
                                <TextBlock Text="{Binding Name}"/>
                            </StackPanel>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
            </Grid>
        </Border>

        <!-- ═══════════════════════════════════════════
             ROW 1: Configuration TabControl
             Tabs: Controller | Mappings | Left Stick | Right Stick | Triggers | Force Feedback | Macros
             ═══════════════════════════════════════════ -->
        <TabControl Grid.Row="1"
                    SelectedIndex="{Binding SelectedConfigTab, Mode=TwoWay}">

            <!-- ─── TAB 0: Controller (slot-level) ─── -->
            <TabItem>
                <TabItem.Header>
                    <TextBlock Text="Controller" FontSize="14" FontWeight="SemiBold" Padding="4,2"/>
                </TabItem.Header>
                <Grid Margin="4">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>      <!-- 3D viewport -->
                        <RowDefinition Height="Auto"/>   <!-- Motor bars -->
                        <RowDefinition Height="Auto"/>   <!-- Map All -->
                    </Grid.RowDefinitions>

                    <!-- ══════════════════════════════════════
                         3D CONTROLLER MODEL
                         Adapted from Handheld Companion (CC BY-NC-SA 4.0)
                         ══════════════════════════════════════ -->
                    <views:ControllerModelView x:Name="ControllerModel3D" Grid.Row="0" />

                    <!-- ══════════════════════════════════════
                         MOTOR ACTIVITY INDICATORS
                         ══════════════════════════════════════ -->
                    <Grid Grid.Row="1" MaxWidth="500" Margin="0,4,0,4" HorizontalAlignment="Center">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="24"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Cursor="Hand"
                                    MouseEnter="Motor_MouseEnter" MouseLeave="Motor_MouseLeave"
                                    MouseLeftButtonDown="LeftMotor_Click"
                                    ToolTip="Click to test left motor"
                                    Background="Transparent">
                            <TextBlock Text="L Motor" FontSize="14"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                       HorizontalAlignment="Center" Margin="0,0,0,2"/>
                            <Border Height="24" Background="#FF1E1E21" CornerRadius="3"
                                    BorderBrush="#FF3F3F46" BorderThickness="1">
                                <Rectangle Fill="#FF2196F3" RadiusX="2" RadiusY="2"
                                           HorizontalAlignment="Left"
                                           Width="{Binding LeftMotorDisplay,
                                               Converter={StaticResource NormToTriggerHeightConverter},
                                               ConverterParameter=240}"/>
                            </Border>
                        </StackPanel>

                        <StackPanel Grid.Column="2" Cursor="Hand"
                                    MouseEnter="Motor_MouseEnter" MouseLeave="Motor_MouseLeave"
                                    MouseLeftButtonDown="RightMotor_Click"
                                    ToolTip="Click to test right motor"
                                    Background="Transparent">
                            <TextBlock Text="R Motor" FontSize="14"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                       HorizontalAlignment="Center" Margin="0,0,0,2"/>
                            <Border Height="24" Background="#FF1E1E21" CornerRadius="3"
                                    BorderBrush="#FF3F3F46" BorderThickness="1">
                                <Rectangle Fill="#FF2196F3" RadiusX="2" RadiusY="2"
                                           HorizontalAlignment="Left"
                                           Width="{Binding RightMotorDisplay,
                                               Converter={StaticResource NormToTriggerHeightConverter},
                                               ConverterParameter=240}"/>
                            </Border>
                        </StackPanel>
                    </Grid>

                    <!-- ══════════════════════════════════════
                         MAP ALL — Controller tab controls
                         ══════════════════════════════════════ -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,4,0,4">
                        <Button Content="Map All" Command="{Binding MapAllCommand}"
                                Padding="16,8" Margin="0,0,8,0" FontSize="14"
                                ToolTip="Sequentially record all mappings — press a button/axis for each prompt"/>
                        <Button Content="Stop" Padding="12,6" FontSize="14"
                                Visibility="{Binding IsMapAllActive, Converter={StaticResource BoolToVisibilityConverter}}"
                                Click="MapAllStop_Click"/>
                        <TextBlock Text="{Binding MapAllPromptText}" FontSize="14" FontWeight="SemiBold"
                                   VerticalAlignment="Center" Margin="8,0,0,0"
                                   Foreground="#FF2196F3"
                                   Visibility="{Binding MapAllPromptText, Converter={StaticResource NullToCollapsedConverter}}"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- Separator between slot-level and device-specific tabs -->
            <TabItem IsEnabled="False" IsHitTestVisible="False">
                <TabItem.Header>
                    <TextBlock Text="|" Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                               FontSize="14" Margin="-4,0"/>
                </TabItem.Header>
            </TabItem>

            <!-- ─── TAB 2: Mappings (device-specific) ─── -->
            <TabItem Header="Mappings">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Toolbar -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="Clear All" Command="{Binding ClearMappingsCommand}"
                                Padding="8,4" Margin="0,0,8,0"/>
                        <Button Content="Copy" Command="{Binding CopySettingsCommand}"
                                Padding="8,4" Margin="0,0,4,0"
                                ToolTip="Copy all mappings and settings to clipboard"/>
                        <Button Content="Paste" Command="{Binding PasteSettingsCommand}"
                                Padding="8,4" Margin="0,0,4,0"
                                ToolTip="Paste mappings and settings from clipboard"/>
                        <Button Content="Copy From..." Command="{Binding CopyFromCommand}"
                                Padding="8,4" Margin="0,0,8,0"
                                ToolTip="Copy settings from another configured device"/>
                        <Button Content="Map All" Command="{Binding MapAllCommand}"
                                Padding="8,4" Margin="0,0,8,0"
                                ToolTip="Sequentially record all mappings one by one"/>
                        <TextBlock Text="Click a mapping row and press a button/axis on your controller to assign it."
                                   VerticalAlignment="Center" FontStyle="Italic"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                    </StackPanel>

                    <!-- Mapping DataGrid -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding Mappings}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserReorderColumns="False"
                              SelectionMode="Single"
                              HeadersVisibility="Column"
                              GridLinesVisibility="Horizontal"
                              IsReadOnly="True"
                              VerticalScrollBarVisibility="Auto">
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <Setter Property="Background">
                                    <Setter.Value>
                                        <SolidColorBrush Color="Transparent"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="Foreground"
                                        Value="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsRecording}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard x:Name="RecordFlash">
                                                <Storyboard>
                                                    <ColorAnimation
                                                        Storyboard.TargetProperty="(DataGridRow.Background).(SolidColorBrush.Color)"
                                                        From="#002196F3" To="#602196F3"
                                                        Duration="0:0:0.4" AutoReverse="True"
                                                        RepeatBehavior="Forever"/>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                        <DataTrigger.ExitActions>
                                            <StopStoryboard BeginStoryboardName="RecordFlash"/>
                                        </DataTrigger.ExitActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Output"
                                                Binding="{Binding TargetLabel}"
                                                Width="130"/>
                            <DataGridTextColumn Header="Source"
                                                Binding="{Binding SourceDisplayText}"
                                                Width="140"/>
                            <DataGridTextColumn Header="Value"
                                                Binding="{Binding CurrentValueText, Mode=OneWay}"
                                                Width="60"/>
                            <!-- Record button -->
                            <DataGridTemplateColumn Header="" Width="90">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="{Binding RecordButtonText}"
                                                Command="{Binding ToggleRecordCommand}"
                                                Padding="6,2" Margin="2"
                                                MinWidth="75" HorizontalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <!-- Clear button -->
                            <DataGridTemplateColumn Header="" Width="55">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Clear"
                                                Command="{Binding ClearCommand}"
                                                Padding="4,2" Margin="2"
                                                HorizontalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <!-- Invert / Half-axis options -->
                            <DataGridTemplateColumn Header="Options" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <CheckBox Content="Inv" IsChecked="{Binding IsInverted, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      Margin="0,0,6,0" VerticalAlignment="Center"/>
                                            <CheckBox Content="Half" IsChecked="{Binding IsHalfAxis, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <!-- ─── TAB 1: Left Stick ─── -->
            <TabItem Header="Left Stick">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="12">
                    <StackPanel>
                        <TextBlock Text="Left Thumbstick Configuration"
                                   FontSize="14" FontWeight="SemiBold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>

                        <!-- Dead Zone X -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Dead Zone X:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding LeftDeadZoneX, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding LeftDeadZoneX, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Dead Zone Y -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Dead Zone Y:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding LeftDeadZoneY, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding LeftDeadZoneY, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Anti-Dead Zone X -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Anti-Dead Zone X:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding LeftAntiDeadZoneX, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding LeftAntiDeadZoneX, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Anti-Dead Zone Y -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Anti-Dead Zone Y:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding LeftAntiDeadZoneY, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding LeftAntiDeadZoneY, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Linear (response curve) -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Linear:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding LeftLinear, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding LeftLinear, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <Separator Margin="0,8,0,12"/>

                        <!-- Live preview -->
                        <TextBlock Text="Live Preview" FontWeight="SemiBold" Margin="0,0,0,8"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                        <Border BorderBrush="#FF3F3F46" BorderThickness="2" CornerRadius="2"
                                Padding="4" Width="212" Height="212" HorizontalAlignment="Left"
                                ClipToBounds="True">
                            <Grid Width="200" Height="200">
                                <!-- Circle background fill -->
                                <Ellipse Width="200" Height="200"
                                         Fill="{DynamicResource ControlFillColorDefaultBrush}"/>
                                <Canvas>
                                    <!-- Boundary circle -->
                                    <Ellipse Width="196" Height="196" Canvas.Left="2" Canvas.Top="2"
                                             Stroke="{DynamicResource ControlStrokeColorDefaultBrush}"
                                             StrokeThickness="1.5" Fill="Transparent"/>
                                    <!-- 50% range ring -->
                                    <Ellipse Width="98" Height="98" Canvas.Left="51" Canvas.Top="51"
                                             Stroke="{DynamicResource ControlStrokeColorSecondaryBrush}"
                                             StrokeDashArray="4 2" StrokeThickness="0.5" Fill="Transparent"/>
                                    <!-- Dead zone ring (scaled by LeftDeadZoneX — max 200px diameter at 100%) -->
                                    <Ellipse Fill="#18FF5722" Stroke="#60FF5722" StrokeThickness="1"
                                             HorizontalAlignment="Center" VerticalAlignment="Center">
                                        <Ellipse.Width>
                                            <Binding Path="LeftDeadZoneX" Converter="{StaticResource PercentToSizeConverter}" ConverterParameter="200"/>
                                        </Ellipse.Width>
                                        <Ellipse.Height>
                                            <Binding Path="LeftDeadZoneY" Converter="{StaticResource PercentToSizeConverter}" ConverterParameter="200"/>
                                        </Ellipse.Height>
                                        <Ellipse.RenderTransform>
                                            <TranslateTransform>
                                                <TranslateTransform.X>
                                                    <Binding Path="LeftDeadZoneX" Converter="{StaticResource PercentToSizeConverter}" ConverterParameter="-100"/>
                                                </TranslateTransform.X>
                                                <TranslateTransform.Y>
                                                    <Binding Path="LeftDeadZoneY" Converter="{StaticResource PercentToSizeConverter}" ConverterParameter="-100"/>
                                                </TranslateTransform.Y>
                                            </TranslateTransform>
                                        </Ellipse.RenderTransform>
                                        <Canvas.Left>100</Canvas.Left>
                                        <Canvas.Top>100</Canvas.Top>
                                    </Ellipse>
                                    <!-- Crosshair -->
                                    <Line X1="100" Y1="0" X2="100" Y2="200"
                                          Stroke="{DynamicResource ControlStrokeColorSecondaryBrush}"
                                          StrokeThickness="0.5"/>
                                    <Line X1="0" Y1="100" X2="200" Y2="100"
                                          Stroke="{DynamicResource ControlStrokeColorSecondaryBrush}"
                                          StrokeThickness="0.5"/>
                                    <!-- Stick position dot (small for dead zone visibility) -->
                                    <Ellipse Width="11" Height="11" Fill="#FF2196F3"
                                             Stroke="#FF1976D2" StrokeThickness="1"
                                             Canvas.Left="{Binding DeviceThumbLX, Converter={StaticResource NormToCanvasConverter}, ConverterParameter='200,11'}"
                                             Canvas.Top="{Binding DeviceThumbLY, Converter={StaticResource NormToCanvasConverter}, ConverterParameter='200,11'}"/>
                                </Canvas>
                            </Grid>
                        </Border>
                        <TextBlock Margin="0,4,0,0"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                            <Run Text="X:"/>
                            <Run Text="{Binding DeviceRawThumbLX, Mode=OneWay}"/>
                            <Run Text="  Y:"/>
                            <Run Text="{Binding DeviceRawThumbLY, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- ─── TAB 2: Right Stick ─── -->
            <TabItem Header="Right Stick">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="12">
                    <StackPanel>
                        <TextBlock Text="Right Thumbstick Configuration"
                                   FontSize="14" FontWeight="SemiBold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>

                        <!-- Dead Zone X -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Dead Zone X:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding RightDeadZoneX, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding RightDeadZoneX, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Dead Zone Y -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Dead Zone Y:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding RightDeadZoneY, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding RightDeadZoneY, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Anti-Dead Zone X -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Anti-Dead Zone X:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding RightAntiDeadZoneX, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding RightAntiDeadZoneX, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Anti-Dead Zone Y -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Anti-Dead Zone Y:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding RightAntiDeadZoneY, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding RightAntiDeadZoneY, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Linear -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Linear:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding RightLinear, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding RightLinear, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <Separator Margin="0,8,0,12"/>

                        <!-- Live preview -->
                        <TextBlock Text="Live Preview" FontWeight="SemiBold" Margin="0,0,0,8"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                        <Border BorderBrush="#FF3F3F46" BorderThickness="2" CornerRadius="2"
                                Padding="4" Width="212" Height="212" HorizontalAlignment="Left"
                                ClipToBounds="True">
                            <Grid Width="200" Height="200">
                                <!-- Circle background fill -->
                                <Ellipse Width="200" Height="200"
                                         Fill="{DynamicResource ControlFillColorDefaultBrush}"/>
                                <Canvas>
                                    <!-- Boundary circle -->
                                    <Ellipse Width="196" Height="196" Canvas.Left="2" Canvas.Top="2"
                                             Stroke="{DynamicResource ControlStrokeColorDefaultBrush}"
                                             StrokeThickness="1.5" Fill="Transparent"/>
                                    <!-- 50% range ring -->
                                    <Ellipse Width="98" Height="98" Canvas.Left="51" Canvas.Top="51"
                                             Stroke="{DynamicResource ControlStrokeColorSecondaryBrush}"
                                             StrokeDashArray="4 2" StrokeThickness="0.5" Fill="Transparent"/>
                                    <!-- Dead zone ring -->
                                    <Ellipse Fill="#18FF5722" Stroke="#60FF5722" StrokeThickness="1"
                                             HorizontalAlignment="Center" VerticalAlignment="Center">
                                        <Ellipse.Width>
                                            <Binding Path="RightDeadZoneX" Converter="{StaticResource PercentToSizeConverter}" ConverterParameter="200"/>
                                        </Ellipse.Width>
                                        <Ellipse.Height>
                                            <Binding Path="RightDeadZoneY" Converter="{StaticResource PercentToSizeConverter}" ConverterParameter="200"/>
                                        </Ellipse.Height>
                                        <Ellipse.RenderTransform>
                                            <TranslateTransform>
                                                <TranslateTransform.X>
                                                    <Binding Path="RightDeadZoneX" Converter="{StaticResource PercentToSizeConverter}" ConverterParameter="-100"/>
                                                </TranslateTransform.X>
                                                <TranslateTransform.Y>
                                                    <Binding Path="RightDeadZoneY" Converter="{StaticResource PercentToSizeConverter}" ConverterParameter="-100"/>
                                                </TranslateTransform.Y>
                                            </TranslateTransform>
                                        </Ellipse.RenderTransform>
                                        <Canvas.Left>100</Canvas.Left>
                                        <Canvas.Top>100</Canvas.Top>
                                    </Ellipse>
                                    <!-- Crosshair -->
                                    <Line X1="100" Y1="0" X2="100" Y2="200"
                                          Stroke="{DynamicResource ControlStrokeColorSecondaryBrush}"
                                          StrokeThickness="0.5"/>
                                    <Line X1="0" Y1="100" X2="200" Y2="100"
                                          Stroke="{DynamicResource ControlStrokeColorSecondaryBrush}"
                                          StrokeThickness="0.5"/>
                                    <!-- Stick position dot (small for dead zone visibility) -->
                                    <Ellipse Width="11" Height="11" Fill="#FF2196F3"
                                             Stroke="#FF1976D2" StrokeThickness="1"
                                             Canvas.Left="{Binding DeviceThumbRX, Converter={StaticResource NormToCanvasConverter}, ConverterParameter='200,11'}"
                                             Canvas.Top="{Binding DeviceThumbRY, Converter={StaticResource NormToCanvasConverter}, ConverterParameter='200,11'}"/>
                                </Canvas>
                            </Grid>
                        </Border>
                        <TextBlock Margin="0,4,0,0"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                            <Run Text="X:"/>
                            <Run Text="{Binding DeviceRawThumbRX, Mode=OneWay}"/>
                            <Run Text="  Y:"/>
                            <Run Text="{Binding DeviceRawThumbRY, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- ─── TAB 3: Triggers ─── -->
            <TabItem Header="Triggers">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="12">
                    <StackPanel>
                        <!-- Left Trigger -->
                        <TextBlock Text="Left Trigger" FontSize="14" FontWeight="SemiBold"
                                   Margin="0,0,0,12"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>

                        <!-- Range (dual-thumb: dead zone floor — max range ceiling) -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Range:" Style="{StaticResource DzLabel}"/>
                            <controls:RangeSlider
                                LowerValue="{Binding LeftTriggerDeadZone, Mode=TwoWay}"
                                UpperValue="{Binding LeftTriggerMaxRange, Mode=TwoWay}"
                                Minimum="0" Maximum="100"
                                Width="200" VerticalAlignment="Center"/>
                            <TextBox Text="{Binding LeftTriggerDeadZone, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="—" VerticalAlignment="Center" Margin="2,0"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                            <TextBox Text="{Binding LeftTriggerMaxRange, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Anti-Dead Zone:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding LeftTriggerAntiDeadZone, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding LeftTriggerAntiDeadZone, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Live value bar -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="Live:" Style="{StaticResource DzLabel}"/>
                            <ProgressBar Value="{Binding DeviceLeftTrigger, Mode=OneWay}"
                                         Minimum="0" Maximum="1"
                                         Width="200" Height="16" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding DeviceRawLeftTrigger, Mode=OneWay}"
                                       Style="{StaticResource DzValue}"/>
                        </StackPanel>

                        <Separator Margin="0,12,0,12"/>

                        <!-- Right Trigger -->
                        <TextBlock Text="Right Trigger" FontSize="14" FontWeight="SemiBold"
                                   Margin="0,0,0,12"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>

                        <!-- Range (dual-thumb: dead zone floor — max range ceiling) -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Range:" Style="{StaticResource DzLabel}"/>
                            <controls:RangeSlider
                                LowerValue="{Binding RightTriggerDeadZone, Mode=TwoWay}"
                                UpperValue="{Binding RightTriggerMaxRange, Mode=TwoWay}"
                                Minimum="0" Maximum="100"
                                Width="200" VerticalAlignment="Center"/>
                            <TextBox Text="{Binding RightTriggerDeadZone, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="—" VerticalAlignment="Center" Margin="2,0"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                            <TextBox Text="{Binding RightTriggerMaxRange, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Anti-Dead Zone:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding RightTriggerAntiDeadZone, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding RightTriggerAntiDeadZone, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="Live:" Style="{StaticResource DzLabel}"/>
                            <ProgressBar Value="{Binding DeviceRightTrigger, Mode=OneWay}"
                                         Minimum="0" Maximum="1"
                                         Width="200" Height="16" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding DeviceRawRightTrigger, Mode=OneWay}"
                                       Style="{StaticResource DzValue}"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- ─── TAB 4: Force Feedback ─── -->
            <TabItem Header="Force Feedback">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="12">
                    <StackPanel>
                        <TextBlock Text="Force Feedback / Rumble"
                                   FontSize="14" FontWeight="SemiBold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>

                        <!-- Overall gain -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Overall Gain:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding ForceOverallGain, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding ForceOverallGain, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Left motor -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Left Motor:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding LeftMotorStrength, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding LeftMotorStrength, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Right motor -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Right Motor:" Style="{StaticResource DzLabel}"/>
                            <Slider Value="{Binding RightMotorStrength, Mode=TwoWay}"
                                    Style="{StaticResource DzSlider}"/>
                            <TextBox Text="{Binding RightMotorStrength, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"
                                     Style="{StaticResource DzValueEdit}"/>
                            <TextBlock Text="%" Style="{StaticResource DzPercent}"/>
                        </StackPanel>

                        <!-- Swap motors -->
                        <CheckBox Content="Swap left/right motors"
                                  IsChecked="{Binding SwapMotors, Mode=TwoWay}"
                                  Margin="0,0,0,12"/>

                        <!-- Test rumble -->
                        <Button Content="Test Rumble"
                                Command="{Binding TestRumbleCommand}"
                                Padding="12,6" HorizontalAlignment="Left"
                                Margin="0,0,0,12"/>

                        <!-- Live motor display -->
                        <TextBlock Text="Motor Activity" FontWeight="SemiBold" Margin="0,8,0,8"
                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="Left Motor:" Style="{StaticResource DzLabel}"/>
                            <ProgressBar Value="{Binding LeftMotorDisplay, Mode=OneWay}"
                                         Minimum="0" Maximum="1"
                                         Width="200" Height="16" VerticalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="Right Motor:" Style="{StaticResource DzLabel}"/>
                            <ProgressBar Value="{Binding RightMotorDisplay, Mode=OneWay}"
                                         Minimum="0" Maximum="1"
                                         Width="200" Height="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Separator between device-specific and slot-level tabs -->
            <TabItem IsEnabled="False" IsHitTestVisible="False">
                <TabItem.Header>
                    <TextBlock Text="|" Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                               FontSize="14" Margin="-4,0"/>
                </TabItem.Header>
            </TabItem>

            <!-- ─── TAB 8: Macros (slot-level) ─── -->
            <TabItem>
                <TabItem.Header>
                    <TextBlock Text="Macros" FontSize="14" FontWeight="SemiBold" Padding="4,2"/>
                </TabItem.Header>
                <Grid Margin="8">
                    <Grid.ColumnDefinitions>
                        <!-- Macro list -->
                        <ColumnDefinition Width="250"/>
                        <!-- Splitter -->
                        <ColumnDefinition Width="Auto"/>
                        <!-- Macro editor -->
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Macro list -->
                    <DockPanel Grid.Column="0">
                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,8">
                            <Button Content="Add" Command="{Binding AddMacroCommand}"
                                    Padding="8,4" Margin="0,0,4,0"/>
                            <Button Content="Remove" Command="{Binding RemoveMacroCommand}"
                                    Padding="8,4"/>
                        </StackPanel>

                        <ListBox ItemsSource="{Binding Macros}"
                                 SelectedItem="{Binding SelectedMacro, Mode=TwoWay}"
                                 DisplayMemberPath="Name"/>
                    </DockPanel>

                    <GridSplitter Grid.Column="1" Width="4" Margin="4,0"
                                  HorizontalAlignment="Center" VerticalAlignment="Stretch"
                                  ResizeBehavior="PreviousAndNext"/>

                    <!-- Macro editor (shows when a macro is selected) -->
                    <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto"
                                  Padding="8"
                                  DataContext="{Binding SelectedMacro}"
                                  Visibility="{Binding DataContext.HasSelectedMacro,
                                      RelativeSource={RelativeSource AncestorType=TabItem},
                                      Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel>
                            <!-- Macro name -->
                            <TextBlock Text="Name" FontWeight="SemiBold" Margin="0,0,0,4"
                                       Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                            <TextBox Text="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0,0,0,12"/>

                            <!-- Enabled -->
                            <CheckBox Content="Enabled" IsChecked="{Binding IsEnabled, Mode=TwoWay}"
                                      Margin="0,0,0,12"/>

                            <!-- Trigger -->
                            <TextBlock Text="Trigger Combination" FontWeight="SemiBold"
                                       Margin="0,0,0,4"
                                       Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <TextBlock Text="Source:" VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <ComboBox SelectedValue="{Binding TriggerSource, Mode=TwoWay}"
                                          SelectedValuePath="Tag" MinWidth="160">
                                    <ComboBoxItem Content="Input Device" Tag="{x:Static vm:MacroTriggerSource.InputDevice}"/>
                                    <ComboBoxItem Content="Output Controller" Tag="{x:Static vm:MacroTriggerSource.OutputController}"/>
                                </ComboBox>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <TextBlock Text="{Binding TriggerDisplayText}"
                                           VerticalAlignment="Center" Margin="0,0,8,0"
                                           MinWidth="150"/>
                                <Button Content="{Binding RecordTriggerButtonText}"
                                        Command="{Binding RecordTriggerCommand}"
                                        Padding="8,4"/>
                            </StackPanel>

                            <!-- Trigger mode -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <TextBlock Text="Fire:" VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <ComboBox SelectedValue="{Binding TriggerMode, Mode=TwoWay}"
                                          SelectedValuePath="Tag" MinWidth="120">
                                    <ComboBoxItem Content="On Press" Tag="{x:Static vm:MacroTriggerMode.OnPress}"/>
                                    <ComboBoxItem Content="On Release" Tag="{x:Static vm:MacroTriggerMode.OnRelease}"/>
                                    <ComboBoxItem Content="While Held" Tag="{x:Static vm:MacroTriggerMode.WhileHeld}"/>
                                </ComboBox>
                            </StackPanel>

                            <CheckBox Content="Consume trigger buttons (hide from game)"
                                      IsChecked="{Binding ConsumeTriggerButtons, Mode=TwoWay}"
                                      Margin="0,0,0,12"/>

                            <!-- Action sequence -->
                            <TextBlock Text="Action Sequence" FontWeight="SemiBold"
                                       Margin="0,0,0,4"
                                       Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <Button Content="Add Action" Command="{Binding AddActionCommand}"
                                        Padding="8,4" Margin="0,0,4,0"/>
                                <Button Content="Remove" Command="{Binding RemoveActionCommand}"
                                        Padding="8,4"/>
                            </StackPanel>
                            <ListBox ItemsSource="{Binding Actions}"
                                     SelectedItem="{Binding SelectedAction, Mode=TwoWay}"
                                     DisplayMemberPath="DisplayText"
                                     MinHeight="100" MaxHeight="200" Margin="0,0,0,4"/>

                            <!-- Action editor (shows when an action is selected) -->
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                                    BorderThickness="1" CornerRadius="4" Padding="8" Margin="0,0,0,12"
                                    DataContext="{Binding SelectedAction}"
                                    Visibility="{Binding DataContext.SelectedAction,
                                        RelativeSource={RelativeSource AncestorType=ScrollViewer},
                                        Converter={StaticResource NullToCollapsedConverter}}">
                                <StackPanel>
                                    <TextBlock Text="Edit Action" FontWeight="SemiBold" Margin="0,0,0,8"
                                               Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>

                                    <!-- Action type -->
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                        <TextBlock Text="Type:" VerticalAlignment="Center"
                                                   Width="80" Margin="0,0,8,0"/>
                                        <ComboBox SelectedValue="{Binding Type, Mode=TwoWay}"
                                                  SelectedValuePath="Tag" MinWidth="150">
                                            <ComboBoxItem Content="Button Press" Tag="{x:Static vm:MacroActionType.ButtonPress}"/>
                                            <ComboBoxItem Content="Button Release" Tag="{x:Static vm:MacroActionType.ButtonRelease}"/>
                                            <ComboBoxItem Content="Key Press" Tag="{x:Static vm:MacroActionType.KeyPress}"/>
                                            <ComboBoxItem Content="Key Release" Tag="{x:Static vm:MacroActionType.KeyRelease}"/>
                                            <ComboBoxItem Content="Delay" Tag="{x:Static vm:MacroActionType.Delay}"/>
                                            <ComboBoxItem Content="Set Axis" Tag="{x:Static vm:MacroActionType.AxisSet}"/>
                                        </ComboBox>
                                    </StackPanel>

                                    <!-- Button flags — checkbox grid for ButtonPress / ButtonRelease -->
                                    <StackPanel Margin="0,0,0,6">
                                        <TextBlock Text="Buttons:" FontWeight="SemiBold" Margin="0,0,0,4"/>
                                        <ItemsControl ItemsSource="{Binding ButtonOptions}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox Content="{Binding Label}"
                                                              IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                              MinWidth="70" Margin="0,0,8,4"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>

                                    <!-- Key combo — for KeyPress / KeyRelease -->
                                    <StackPanel Margin="0,0,0,6">
                                        <TextBlock Text="Key Combo:" FontWeight="SemiBold" Margin="0,0,0,4"/>
                                        <TextBox Text="{Binding KeyString, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                 FontFamily="Consolas" Margin="0,0,0,4"
                                                 ToolTip="Key combo in {Key1}{Key2} format — editable"/>
                                        <StackPanel Orientation="Horizontal">
                                            <ComboBox ItemsSource="{x:Static vm:MacroAction.VirtualKeyValues}"
                                                      SelectedItem="{Binding SelectedKeyToAdd, Mode=TwoWay}"
                                                      MinWidth="180" MaxDropDownHeight="300"
                                                      IsTextSearchEnabled="True"/>
                                            <Button Content="Clear" Command="{Binding ClearKeyStringCommand}"
                                                    Padding="8,4" Margin="4,0,0,0"/>
                                        </StackPanel>
                                        <TextBlock Text="Select a key to add it. Example: {Control}{Alt}{Delete}"
                                                   FontSize="11" Margin="0,4,0,0" TextWrapping="Wrap"
                                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                    </StackPanel>

                                    <!-- Duration — for ButtonPress / KeyPress / Delay -->
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                        <TextBlock Text="Duration:" VerticalAlignment="Center"
                                                   Width="80" Margin="0,0,8,0"/>
                                        <TextBox Text="{Binding DurationMs, Mode=TwoWay}" Width="80"/>
                                        <TextBlock Text="ms" VerticalAlignment="Center" Margin="4,0,0,0"/>
                                    </StackPanel>

                                    <!-- Axis target + value — for AxisSet -->
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                        <TextBlock Text="Axis:" VerticalAlignment="Center"
                                                   Width="80" Margin="0,0,8,0"/>
                                        <ComboBox SelectedValue="{Binding AxisTarget, Mode=TwoWay}"
                                                  SelectedValuePath="Tag" MinWidth="120">
                                            <ComboBoxItem Content="None" Tag="{x:Static vm:MacroAxisTarget.None}"/>
                                            <ComboBoxItem Content="Left Stick X" Tag="{x:Static vm:MacroAxisTarget.LeftStickX}"/>
                                            <ComboBoxItem Content="Left Stick Y" Tag="{x:Static vm:MacroAxisTarget.LeftStickY}"/>
                                            <ComboBoxItem Content="Right Stick X" Tag="{x:Static vm:MacroAxisTarget.RightStickX}"/>
                                            <ComboBoxItem Content="Right Stick Y" Tag="{x:Static vm:MacroAxisTarget.RightStickY}"/>
                                            <ComboBoxItem Content="Left Trigger" Tag="{x:Static vm:MacroAxisTarget.LeftTrigger}"/>
                                            <ComboBoxItem Content="Right Trigger" Tag="{x:Static vm:MacroAxisTarget.RightTrigger}"/>
                                        </ComboBox>
                                        <TextBlock Text="Value:" VerticalAlignment="Center"
                                                   Margin="12,0,8,0"/>
                                        <TextBox Text="{Binding AxisValue, Mode=TwoWay}" Width="80"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Repeat settings -->
                            <TextBlock Text="Repeat" FontWeight="SemiBold" Margin="0,0,0,4"
                                       Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <TextBlock Text="Mode:" VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <ComboBox SelectedValue="{Binding RepeatMode, Mode=TwoWay}"
                                          SelectedValuePath="Tag" MinWidth="120">
                                    <ComboBoxItem Content="Once" Tag="{x:Static vm:MacroRepeatMode.Once}"/>
                                    <ComboBoxItem Content="Fixed Count" Tag="{x:Static vm:MacroRepeatMode.FixedCount}"/>
                                    <ComboBoxItem Content="Until Release" Tag="{x:Static vm:MacroRepeatMode.UntilRelease}"/>
                                </ComboBox>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <TextBlock Text="Count:" VerticalAlignment="Center"
                                           Margin="0,0,8,0" Width="50"/>
                                <TextBox Text="{Binding RepeatCount, Mode=TwoWay}"
                                         Width="60"/>
                                <TextBlock Text="Delay (ms):" VerticalAlignment="Center"
                                           Margin="12,0,8,0"/>
                                <TextBox Text="{Binding RepeatDelayMs, Mode=TwoWay}"
                                         Width="60"/>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>
