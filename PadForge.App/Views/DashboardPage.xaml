<UserControl x:Class="PadForge.Views.DashboardPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.modernwpf.com/2019">

    <ScrollViewer Padding="24,16">
        <StackPanel MaxWidth="960">

            <!-- Page header -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                <TextBlock Text="&#xE80F;" FontFamily="Segoe MDL2 Assets" FontSize="20"
                           VerticalAlignment="Center" Margin="0,0,10,0"/>
                <TextBlock Text="Dashboard" Style="{StaticResource TitleTextBlockStyle}"/>
            </StackPanel>

            <!-- ═══ Input Engine ═══ -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                <TextBlock Text="&#xE9F5;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBlock Text="Input Engine" Style="{StaticResource SubtitleTextBlockStyle}"/>
            </StackPanel>

            <Border Style="{StaticResource CardBorder}" Padding="20" Margin="0,0,0,16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Engine power toggle -->
                    <Button Padding="2" MinWidth="0" MinHeight="0"
                            VerticalAlignment="Center" Cursor="Hand"
                            Background="Transparent" BorderThickness="0"
                            Click="EngineToggle_Click" Margin="0,0,8,0">
                        <TextBlock Text="&#xE7E8;" FontFamily="Segoe MDL2 Assets" FontSize="16">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="#FFF44336"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding EngineStatus}" Value="Running">
                                            <Setter Property="Foreground" Value="#FF4CAF50"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Button>

                    <TextBlock Grid.Column="1" Text="{Binding EngineStatus}" Opacity="0.8"
                               VerticalAlignment="Center"/>

                    <TextBlock Grid.Column="2" VerticalAlignment="Center" Margin="24,0"
                               Opacity="0.7">
                        <Run Text="{Binding PollingFrequencyText, Mode=OneWay}"/>
                    </TextBlock>

                    <StackPanel Grid.Column="3" VerticalAlignment="Center">
                        <TextBlock Opacity="0.6" FontSize="12">
                            <Run Text="{Binding OnlineDevices, Mode=OneWay}"/>
                            <Run Text="/"/>
                            <Run Text="{Binding TotalDevices, Mode=OneWay}"/>
                            <Run Text="devices online"/>
                        </TextBlock>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ═══ Virtual controller slot cards ═══ -->
            <StackPanel Orientation="Horizontal" Margin="0,8,0,12">
                <TextBlock Text="&#xE7FC;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBlock Text="Virtual Controllers" Style="{StaticResource SubtitleTextBlockStyle}"/>
            </StackPanel>

            <ItemsControl x:Name="SlotsItemsControl" ItemsSource="{Binding SlotSummaries}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                                CornerRadius="8" Padding="10" Margin="4"
                                BorderThickness="2" BorderBrush="Transparent"
                                MinWidth="220" MaxWidth="320"
                                Tag="{Binding PadIndex}"
                                Loaded="SlotCard_Loaded">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- Row 0: [Power] [Gamepad] #N | [Xbox][PS] #N [X] -->
                                <StackPanel Orientation="Horizontal">
                                    <!-- Power button -->
                                    <Button Padding="2" MinWidth="0" MinHeight="0"
                                            VerticalAlignment="Center" Cursor="Hand"
                                            Click="PowerToggle_Click" Tag="{Binding PadIndex}">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Background" Value="Transparent"/>
                                                <Setter Property="BorderThickness" Value="0"/>
                                                <Setter Property="ToolTip" Value="Disabled"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsEnabled}" Value="True">
                                                        <Setter Property="ToolTip" Value="Active"/>
                                                    </DataTrigger>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding IsEnabled}" Value="True"/>
                                                            <Condition Binding="{Binding ConnectedDeviceCount}" Value="0"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="ToolTip" Value="Awaiting controllers"/>
                                                    </MultiDataTrigger>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding IsEnabled}" Value="True"/>
                                                            <Condition Binding="{Binding DataContext.IsViGEmInstalled, RelativeSource={RelativeSource AncestorType=ItemsControl}}" Value="False"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="ToolTip" Value="ViGEmBus not installed"/>
                                                    </MultiDataTrigger>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding IsEnabled}" Value="True"/>
                                                            <Condition Binding="{Binding DataContext.EngineStatus, RelativeSource={RelativeSource AncestorType=ItemsControl}}" Value="Stopped"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="ToolTip" Value="Engine stopped"/>
                                                    </MultiDataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                        <TextBlock Text="&#xE7E8;" FontFamily="Segoe MDL2 Assets" FontSize="14">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <!-- Default: red (disabled) -->
                                                    <Setter Property="Foreground" Value="#FFF44336"/>
                                                    <Style.Triggers>
                                                        <!-- Enabled + devices connected: green -->
                                                        <DataTrigger Binding="{Binding IsEnabled}" Value="True">
                                                            <Setter Property="Foreground" Value="#FF4CAF50"/>
                                                        </DataTrigger>
                                                        <!-- Enabled but no devices connected: yellow (awaiting) -->
                                                        <MultiDataTrigger>
                                                            <MultiDataTrigger.Conditions>
                                                                <Condition Binding="{Binding IsEnabled}" Value="True"/>
                                                                <Condition Binding="{Binding ConnectedDeviceCount}" Value="0"/>
                                                            </MultiDataTrigger.Conditions>
                                                            <Setter Property="Foreground" Value="#FFFFC107"/>
                                                        </MultiDataTrigger>
                                                        <!-- Enabled but ViGEmBus not installed: yellow -->
                                                        <MultiDataTrigger>
                                                            <MultiDataTrigger.Conditions>
                                                                <Condition Binding="{Binding IsEnabled}" Value="True"/>
                                                                <Condition Binding="{Binding DataContext.IsViGEmInstalled, RelativeSource={RelativeSource AncestorType=ItemsControl}}" Value="False"/>
                                                            </MultiDataTrigger.Conditions>
                                                            <Setter Property="Foreground" Value="#FFFFC107"/>
                                                        </MultiDataTrigger>
                                                        <!-- Enabled but engine stopped: yellow -->
                                                        <MultiDataTrigger>
                                                            <MultiDataTrigger.Conditions>
                                                                <Condition Binding="{Binding IsEnabled}" Value="True"/>
                                                                <Condition Binding="{Binding DataContext.EngineStatus, RelativeSource={RelativeSource AncestorType=ItemsControl}}" Value="Stopped"/>
                                                            </MultiDataTrigger.Conditions>
                                                            <Setter Property="Foreground" Value="#FFFFC107"/>
                                                        </MultiDataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Button>

                                    <!-- Gamepad icon + global slot # -->
                                    <TextBlock Text="&#xE7FC;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                               VerticalAlignment="Center" Margin="6,0,0,0"/>
                                    <TextBlock VerticalAlignment="Center" FontWeight="SemiBold"
                                               FontSize="13" Margin="3,0,0,0">
                                        <Run Text="{Binding SlotNumber, Mode=OneWay}"/>
                                    </TextBlock>

                                    <!-- Separator -->
                                    <TextBlock Text="|" FontSize="12" Opacity="0.3"
                                               VerticalAlignment="Center" Margin="8,0,8,0"/>

                                    <!-- Xbox type button -->
                                    <Button ToolTip="Xbox 360" Background="Transparent"
                                            Padding="2" MinWidth="0" MinHeight="0" Cursor="Hand"
                                            VerticalAlignment="Center"
                                            Click="XboxType_Click" Tag="{Binding PadIndex}">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Opacity" Value="0.3"/>
                                                <Setter Property="BorderThickness" Value="0"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding OutputType}" Value="Xbox360">
                                                        <Setter Property="Opacity" Value="1.0"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                        <Path Data="M16 5.425c-1.888-1.125-4.106-1.922-6.473-2.249l-0.092-0.010c-0.070-0.005-0.152-0.008-0.234-0.008-0.613 0-1.188 0.16-1.687 0.441l0.017-0.009c2.357-1.634 5.277-2.61 8.426-2.61 0.008 0 0.016 0 0.024 0h0.019c0.005 0 0.011 0 0.018 0 3.157 0 6.086 0.976 8.501 2.642l-0.050-0.033c-0.478-0.272-1.051-0.433-1.662-0.433-0.085 0-0.169 0.003-0.252 0.009l0.011-0.001c-2.459 0.336-4.677 1.13-6.648 2.297l0.082-0.045zM5.554 5.268c-0.041 0.014-0.077 0.032-0.11 0.054l0.002-0.001c-2.758 2.723-4.466 6.504-4.466 10.684 0 3.584 1.256 6.875 3.353 9.457l-0.022-0.028c-1.754-3.261 4.48-12.455 7.61-16.159-3.53-3.521-5.277-4.062-6.015-4.062-0.010-0-0.021-0.001-0.032-0.001-0.115 0-0.225 0.021-0.326 0.060l0.006-0.002zM20.083 9.275c3.129 3.706 9.367 12.908 7.605 16.161 2.075-2.554 3.332-5.845 3.332-9.43 0-4.181-1.709-7.962-4.467-10.684l-0.002-0.002c-0.029-0.021-0.063-0.039-0.1-0.052l-0.003-0.001c-0.1-0.036-0.216-0.056-0.336-0.056-0.005 0-0.011 0-0.016 0h0.001c-0.741-0-2.485 0.543-6.014 4.063zM6.114 27.306c2.627 2.306 6.093 3.714 9.888 3.714s7.261-1.407 9.905-3.728l-0.017 0.015c2.349-2.393-5.402-10.901-9.89-14.29-4.483 3.39-12.24 11.897-9.886 14.29z"
                                              Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                              Width="14" Height="14" Stretch="Uniform"/>
                                    </Button>

                                    <!-- PS type button -->
                                    <Button ToolTip="DualShock 4" Background="Transparent"
                                            Padding="2" MinWidth="0" MinHeight="0" Cursor="Hand"
                                            VerticalAlignment="Center" Margin="2,0,0,0"
                                            Click="DS4Type_Click" Tag="{Binding PadIndex}">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Opacity" Value="0.3"/>
                                                <Setter Property="BorderThickness" Value="0"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding OutputType}" Value="DualShock4">
                                                        <Setter Property="Opacity" Value="1.0"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                        <Path Data="M3.262 24.248c-2.374-0.681-2.767-2.084-1.69-2.899 0.776-0.51 1.668-0.954 2.612-1.288l0.087-0.027 7.017-2.516v2.89l-5.030 1.839c-0.881 0.339-1.031 0.79-0.299 1.032 0.365 0.093 0.783 0.147 1.214 0.147 0.615 0 1.204-0.109 1.749-0.308l-0.035 0.011 2.422-0.882v2.592c-0.15 0.037-0.32 0.055-0.487 0.091-0.775 0.136-1.667 0.214-2.577 0.214-1.778 0-3.486-0.298-5.078-0.846l0.110 0.033zM18.049 24.544l7.868-2.843c0.893-0.322 1.032-0.781 0.307-1.022-0.363-0.089-0.779-0.14-1.208-0.14-0.622 0-1.22 0.108-1.774 0.305l0.037-0.011-5.255 1.874v-2.983l0.3-0.106c1.050-0.349 2.284-0.62 3.557-0.761l0.083-0.008c0.468-0.050 1.010-0.078 1.559-0.078 1.877 0 3.677 0.331 5.343 0.939l-0.108-0.035c2.309 0.751 2.549 1.839 1.969 2.589-0.559 0.557-1.235 0.998-1.988 1.282l-0.039 0.013-10.677 3.883v-2.869zM12.231 4.248v21.927l4.892 1.576v-18.39c0-0.862 0.38-1.438 0.992-1.238 0.795 0.225 0.95 1.017 0.95 1.881v7.342c3.050 1.491 5.451-0.003 5.451-3.939 0-4.045-1.407-5.842-5.546-7.282-1.785-0.648-4.040-1.294-6.347-1.805l-0.389-0.072z"
                                              Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                              Width="14" Height="14" Stretch="Uniform"/>
                                    </Button>

                                    <!-- vJoy type button -->
                                    <Button ToolTip="vJoy" Background="Transparent"
                                            Padding="2" MinWidth="0" MinHeight="0" Cursor="Hand"
                                            VerticalAlignment="Center" Margin="2,0,0,0"
                                            Click="VJoyType_Click" Tag="{Binding PadIndex}">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Opacity" Value="0.3"/>
                                                <Setter Property="BorderThickness" Value="0"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding OutputType}" Value="VJoy">
                                                        <Setter Property="Opacity" Value="1.0"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                        <Path Data="M11.915 15H13V9.874A4.002 4.002 0 0 1 14 2a4 4 0 0 1 1 7.874V15h2a3 3 0 0 1 3 3v4H4v-4a3 3 0 0 1 3-3h.085A1.5 1.5 0 0 1 8.5 14h2a1.5 1.5 0 0 1 1.415 1z"
                                              Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                              Width="14" Height="14" Stretch="Uniform"/>
                                    </Button>

                                    <!-- Per-type instance # -->
                                    <TextBlock Text="{Binding TypeInstanceLabel}"
                                               FontSize="11" Opacity="0.6"
                                               VerticalAlignment="Center" Margin="4,0,0,0"/>

                                </StackPanel>

                                <!-- Delete button (upper-right corner) -->
                                <Button ToolTip="Delete virtual controller"
                                        Background="Transparent" Padding="2" MinWidth="0" MinHeight="0"
                                        HorizontalAlignment="Right" VerticalAlignment="Top"
                                        Margin="0" Opacity="0.5"
                                        Click="DeleteSlot_Click" Tag="{Binding PadIndex}">
                                    <TextBlock Text="&#xE711;" FontFamily="Segoe MDL2 Assets" FontSize="11"/>
                                </Button>

                                <!-- Row 1: Device name (compact) -->
                                <TextBlock Grid.Row="1" Text="{Binding DeviceName}"
                                           FontSize="12" Opacity="0.6" Margin="0,4,0,0"
                                           TextTrimming="CharacterEllipsis"/>

                                <!-- Row 2: Status -->
                                <StackPanel Grid.Row="2" Orientation="Horizontal"
                                            Margin="0,2,0,0">
                                    <TextBlock Text="{Binding StatusText}"
                                               FontSize="11" Opacity="0.5"/>
                                    <TextBlock FontSize="11" Opacity="0.5" Margin="8,0,0,0">
                                        <Run Text="{Binding MappedDeviceCount, Mode=OneWay}"/>
                                        <Run Text="mapped,"/>
                                        <Run Text="{Binding ConnectedDeviceCount, Mode=OneWay}"/>
                                        <Run Text="connected"/>
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Add Controller card -->
            <Border x:Name="AddControllerCard"
                    Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                    CornerRadius="8" Padding="16" Margin="4,4,4,4"
                    Cursor="Hand" MouseLeftButtonUp="AddControllerCard_Click"
                    Visibility="{Binding ShowAddController, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"
                            VerticalAlignment="Center">
                    <TextBlock Text="&#xE710;" FontFamily="Segoe MDL2 Assets" FontSize="20"
                               VerticalAlignment="Center" Margin="0,0,8,0" Opacity="0.5"/>
                    <TextBlock Text="Add Controller" FontSize="14"
                               VerticalAlignment="Center" Opacity="0.5"/>
                </StackPanel>
            </Border>

            <!-- ═══ Motion Server ═══ -->
            <StackPanel Orientation="Horizontal" Margin="0,20,0,12">
                <TextBlock Text="&#xEC05;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBlock Text="Motion Server" Style="{StaticResource SubtitleTextBlockStyle}"/>
            </StackPanel>

            <Border Style="{StaticResource CardBorder}" Margin="0,0,0,0">
                <StackPanel>
                    <TextBlock Text="DSU/cemuhook server for gyro and accelerometer data."
                               Style="{StaticResource CardDescription}" Margin="0,0,0,12"/>
                    <CheckBox Content="Enable DSU motion server (cemuhook)"
                              IsChecked="{Binding EnableDsuMotionServer}" Margin="0,0,0,8"/>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <TextBlock Text="Port:" VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        <ui:NumberBox Value="{Binding DsuMotionServerPort, Mode=TwoWay}"
                                      Minimum="1024" Maximum="65535"
                                      SpinButtonPlacementMode="Inline" Width="140"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                        <Ellipse Width="8" Height="8"
                                 Fill="{Binding EnableDsuMotionServer, Converter={StaticResource BoolToColorConverter}}"
                                 VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding DsuServerStatus}" FontSize="12"/>
                    </StackPanel>
                    <TextBlock Text="Provides gyro/accel data to Cemu, Dolphin, Yuzu, etc."
                               FontSize="12" Opacity="0.5" Margin="0,4,0,0"/>
                </StackPanel>
            </Border>

            <!-- ═══ Driver status ═══ -->
            <StackPanel Orientation="Horizontal" Margin="0,20,0,12">
                <TextBlock Text="&#xE964;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBlock Text="Drivers" Style="{StaticResource SubtitleTextBlockStyle}"/>
            </StackPanel>

            <Border Style="{StaticResource CardBorder}" Padding="20" Margin="0,0,0,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#xED1A;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                   VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock Text="HidHide" FontWeight="SemiBold"/>
                    </StackPanel>
                    <TextBlock Grid.Column="1" Text="{Binding HidHideStatusText}" Opacity="0.7"/>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,8,0,0">
                        <TextBlock Text="&#xE7FC;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                   VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock Text="ViGEmBus" FontWeight="SemiBold"/>
                    </StackPanel>
                    <TextBlock Grid.Row="1" Grid.Column="1"
                               Text="{Binding ViGEmStatusText}" Opacity="0.7"
                               Margin="0,8,0,0"/>

                    <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,8,0,0">
                        <Path Data="M11.915 15H13V9.874A4.002 4.002 0 0 1 14 2a4 4 0 0 1 1 7.874V15h2a3 3 0 0 1 3 3v4H4v-4a3 3 0 0 1 3-3h.085A1.5 1.5 0 0 1 8.5 14h2a1.5 1.5 0 0 1 1.415 1z"
                              Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                              Width="14" Height="14" Stretch="Uniform"
                              VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock Text="vJoy" FontWeight="SemiBold"/>
                    </StackPanel>
                    <TextBlock Grid.Row="2" Grid.Column="1"
                               Text="{Binding VJoyStatusText}" Opacity="0.7"
                               Margin="0,8,0,0"/>

                </Grid>
            </Border>

        </StackPanel>
    </ScrollViewer>
</UserControl>
