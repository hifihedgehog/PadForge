<UserControl x:Class="PadForge.Views.DevicesPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.modernwpf.com/2019"
             xmlns:sys="clr-namespace:System;assembly=System.Runtime"
             xmlns:engine="clr-namespace:PadForge.Engine;assembly=PadForge.Engine">

    <Grid Margin="24,16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
            <TextBlock Text="Devices" Style="{StaticResource TitleTextBlockStyle}"/>
            <Button Content="Refresh" Margin="16,0,0,0"
                    Command="{Binding RefreshCommand}"/>
            <TextBlock VerticalAlignment="Center" Margin="16,0" Opacity="0.6">
                <Run Text="{Binding OnlineCount, Mode=OneWay}"/>
                <Run Text="online /"/>
                <Run Text="{Binding TotalCount, Mode=OneWay}"/>
                <Run Text="total"/>
            </TextBlock>
        </StackPanel>

        <!-- Main content: Card list + Detail -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="340"/>
            </Grid.ColumnDefinitions>

            <!-- ═══════════════════════════════════════════ -->
            <!--  Left: Device card list                    -->
            <!-- ═══════════════════════════════════════════ -->
            <ListBox ItemsSource="{Binding Devices}"
                     SelectedItem="{Binding SelectedDevice, Mode=TwoWay}"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                     BorderThickness="0" Background="Transparent"
                     Margin="0,0,12,0">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                                CornerRadius="8" Padding="12,10" Margin="0,0,0,4">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- Row 0: Status dot + Device name -->
                                <StackPanel Orientation="Horizontal">
                                    <Ellipse Width="8" Height="8"
                                             Fill="{Binding IsOnline, Converter={StaticResource BoolToColorConverter}}"
                                             VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding DeviceName}" FontWeight="SemiBold"
                                               FontSize="13" TextTrimming="CharacterEllipsis"
                                               VerticalAlignment="Center"/>
                                </StackPanel>

                                <!-- Slot badges (right, row 0) -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal"
                                            VerticalAlignment="Center" Margin="8,0,0,0">
                                    <ItemsControl ItemsSource="{Binding SlotBadges}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Orientation="Horizontal"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border CornerRadius="4" Padding="5,2"
                                                        Margin="0,0,4,0"
                                                        Background="{DynamicResource SystemControlBackgroundListLowBrush}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <!-- Gamepad icon -->
                                                        <TextBlock Text="&#xE7FC;" FontFamily="Segoe MDL2 Assets"
                                                                   FontSize="10" Opacity="0.6"
                                                                   VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding SlotNumber}" FontSize="10"
                                                                   Opacity="0.7" Margin="3,0,5,0"
                                                                   VerticalAlignment="Center"/>
                                                        <!-- Xbox icon -->
                                                        <Path Data="M16 5.425c-1.888-1.125-4.106-1.922-6.473-2.249l-0.092-0.010c-0.070-0.005-0.152-0.008-0.234-0.008-0.613 0-1.188 0.16-1.687 0.441l0.017-0.009c2.357-1.634 5.277-2.61 8.426-2.61 0.008 0 0.016 0 0.024 0h0.019c0.005 0 0.011 0 0.018 0 3.157 0 6.086 0.976 8.501 2.642l-0.050-0.033c-0.478-0.272-1.051-0.433-1.662-0.433-0.085 0-0.169 0.003-0.252 0.009l0.011-0.001c-2.459 0.336-4.677 1.13-6.648 2.297l0.082-0.045zM5.554 5.268c-0.041 0.014-0.077 0.032-0.11 0.054l0.002-0.001c-2.758 2.723-4.466 6.504-4.466 10.684 0 3.584 1.256 6.875 3.353 9.457l-0.022-0.028c-1.754-3.261 4.48-12.455 7.61-16.159-3.53-3.521-5.277-4.062-6.015-4.062-0.010-0-0.021-0.001-0.032-0.001-0.115 0-0.225 0.021-0.326 0.060l0.006-0.002zM20.083 9.275c3.129 3.706 9.367 12.908 7.605 16.161 2.075-2.554 3.332-5.845 3.332-9.43 0-4.181-1.709-7.962-4.467-10.684l-0.002-0.002c-0.029-0.021-0.063-0.039-0.1-0.052l-0.003-0.001c-0.1-0.036-0.216-0.056-0.336-0.056-0.005 0-0.011 0-0.016 0h0.001c-0.741-0-2.485 0.543-6.014 4.063zM6.114 27.306c2.627 2.306 6.093 3.714 9.888 3.714s7.261-1.407 9.905-3.728l-0.017 0.015c2.349-2.393-5.402-10.901-9.89-14.29-4.483 3.39-12.24 11.897-9.886 14.29z"
                                                              Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                              Width="8" Height="8" Stretch="Uniform"
                                                              VerticalAlignment="Center" Opacity="0.6">
                                                            <Path.Style>
                                                                <Style TargetType="Path">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding ControllerType}" Value="Xbox360">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Path.Style>
                                                        </Path>
                                                        <!-- DS4 icon -->
                                                        <Path Data="M3.262 24.248c-2.374-0.681-2.767-2.084-1.69-2.899 0.776-0.51 1.668-0.954 2.612-1.288l0.087-0.027 7.017-2.516v2.89l-5.030 1.839c-0.881 0.339-1.031 0.79-0.299 1.032 0.365 0.093 0.783 0.147 1.214 0.147 0.615 0 1.204-0.109 1.749-0.308l-0.035 0.011 2.422-0.882v2.592c-0.15 0.037-0.32 0.055-0.487 0.091-0.775 0.136-1.667 0.214-2.577 0.214-1.778 0-3.486-0.298-5.078-0.846l0.110 0.033zM18.049 24.544l7.868-2.843c0.893-0.322 1.032-0.781 0.307-1.022-0.363-0.089-0.779-0.14-1.208-0.14-0.622 0-1.22 0.108-1.774 0.305l0.037-0.011-5.255 1.874v-2.983l0.3-0.106c1.050-0.349 2.284-0.62 3.557-0.761l0.083-0.008c0.468-0.050 1.010-0.078 1.559-0.078 1.877 0 3.677 0.331 5.343 0.939l-0.108-0.035c2.309 0.751 2.549 1.839 1.969 2.589-0.559 0.557-1.235 0.998-1.988 1.282l-0.039 0.013-10.677 3.883v-2.869zM12.231 4.248v21.927l4.892 1.576v-18.39c0-0.862 0.38-1.438 0.992-1.238 0.795 0.225 0.95 1.017 0.95 1.881v7.342c3.050 1.491 5.451-0.003 5.451-3.939 0-4.045-1.407-5.842-5.546-7.282-1.785-0.648-4.040-1.294-6.347-1.805l-0.389-0.072z"
                                                              Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                              Width="8" Height="8" Stretch="Uniform"
                                                              VerticalAlignment="Center" Opacity="0.6">
                                                            <Path.Style>
                                                                <Style TargetType="Path">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding ControllerType}" Value="DualShock4">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Path.Style>
                                                        </Path>
                                                        <!-- vJoy icon -->
                                                        <Path Data="M11.915 15H13V9.874A4.002 4.002 0 0 1 14 2a4 4 0 0 1 1 7.874V15h2a3 3 0 0 1 3 3v4H4v-4a3 3 0 0 1 3-3h.085A1.5 1.5 0 0 1 8.5 14h2a1.5 1.5 0 0 1 1.415 1z"
                                                              Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                              Width="8" Height="8" Stretch="Uniform"
                                                              VerticalAlignment="Center" Opacity="0.6">
                                                            <Path.Style>
                                                                <Style TargetType="Path">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding ControllerType}" Value="VJoy">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Path.Style>
                                                        </Path>
                                                        <TextBlock Text="{Binding TypeInstanceNumber}" FontSize="10"
                                                                   Opacity="0.7" Margin="2,0,0,0"
                                                                   VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    <!-- Unassigned fallback -->
                                    <TextBlock Text="Unassigned" FontSize="11" Opacity="0.55"
                                               Visibility="{Binding IsUnassigned, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                </StackPanel>

                                <!-- Row 1: Type | VID:PID | Capabilities -->
                                <StackPanel Grid.Row="1" Grid.ColumnSpan="2"
                                            Orientation="Horizontal" Margin="16,3,0,0">
                                    <TextBlock Text="{Binding DeviceType}" FontSize="11" Opacity="0.55"/>
                                    <TextBlock Text=" &#x2022; " FontSize="11" Opacity="0.3"/>
                                    <TextBlock FontSize="11" Opacity="0.45" FontFamily="Consolas">
                                        <Run Text="{Binding VendorIdHex, Mode=OneWay}"/>:<Run Text="{Binding ProductIdHex, Mode=OneWay}"/>
                                    </TextBlock>
                                    <TextBlock Text=" &#x2022; " FontSize="11" Opacity="0.3"/>
                                    <TextBlock Text="{Binding CapabilitiesSummary}" FontSize="11" Opacity="0.45"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <Grid>
                                        <!-- Selection accent bar (left edge) -->
                                        <Border x:Name="SelectionBar" Width="4"
                                                HorizontalAlignment="Left" CornerRadius="2"
                                                Background="{DynamicResource SystemControlHighlightAccentBrush}"
                                                Visibility="Collapsed" Margin="0,2"/>
                                        <ContentPresenter Margin="6,0,0,0"/>
                                    </Grid>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="SelectionBar" Property="Visibility" Value="Visible"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>
            </ListBox>

            <!-- ═══════════════════════════════════════════ -->
            <!--  Right: Detail panel                       -->
            <!-- ═══════════════════════════════════════════ -->
            <Border Grid.Column="1"
                    Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                    CornerRadius="8" Padding="14,12">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              Visibility="{Binding HasSelectedDevice, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>

                        <!-- Device identity -->
                        <TextBlock Text="{Binding SelectedDevice.DeviceName}"
                                   FontSize="16" FontWeight="SemiBold"
                                   TextWrapping="Wrap" Margin="0,0,0,6"/>

                        <TextBlock FontSize="11" Opacity="0.7" Margin="0,0,0,1">
                            <Run Text="Product:"/>
                            <Run Text="{Binding SelectedDevice.ProductName, Mode=OneWay}"/>
                        </TextBlock>
                        <TextBlock FontSize="11" Opacity="0.7" Margin="0,0,0,1">
                            <Run Text="VID:PID:"/>
                            <Run Text="{Binding SelectedDevice.VendorIdHex, Mode=OneWay}"/>
                            <Run Text=":"/>
                            <Run Text="{Binding SelectedDevice.ProductIdHex, Mode=OneWay}"/>
                        </TextBlock>
                        <TextBlock FontSize="11" Opacity="0.7" Margin="0,0,0,1">
                            <Run Text="Type:"/>
                            <Run Text="{Binding SelectedDevice.DeviceType, Mode=OneWay}"/>
                        </TextBlock>
                        <TextBlock FontSize="11" Opacity="0.6" Margin="0,0,0,1">
                            <Run Text="{Binding SelectedDevice.CapabilitiesSummary, Mode=OneWay}"/>
                        </TextBlock>
                        <TextBlock FontSize="10" Opacity="0.4" Margin="0,0,0,4"
                                   TextWrapping="Wrap" FontFamily="Consolas">
                            <Run Text="GUID:"/>
                            <Run Text="{Binding SelectedDevice.InstanceGuid, Mode=OneWay}"/>
                        </TextBlock>

                        <Separator Margin="0,2,0,6"/>

                        <!-- Assign to slot + Remove -->
                        <WrapPanel Margin="0,0,0,6">
                            <ItemsControl ItemsSource="{Binding ActiveSlotItems}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <ToggleButton IsChecked="{Binding IsAssigned, Mode=OneWay}"
                                                      Command="{Binding DataContext.ToggleSlotCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                      CommandParameter="{Binding PadIndex}"
                                                      Margin="0,0,3,3" Padding="5,3"
                                                      ToolTip="Toggle assignment">
                                            <StackPanel Orientation="Horizontal">
                                                <!-- Gamepad icon + slot number -->
                                                <TextBlock Text="&#xE7FC;" FontFamily="Segoe MDL2 Assets"
                                                           FontSize="10" VerticalAlignment="Center"/>
                                                <TextBlock Text="{Binding SlotNumber}" FontSize="10"
                                                           VerticalAlignment="Center" Margin="3,0,5,0"/>
                                                <!-- Xbox icon -->
                                                <Path Data="M16 5.425c-1.888-1.125-4.106-1.922-6.473-2.249l-0.092-0.010c-0.070-0.005-0.152-0.008-0.234-0.008-0.613 0-1.188 0.16-1.687 0.441l0.017-0.009c2.357-1.634 5.277-2.61 8.426-2.61 0.008 0 0.016 0 0.024 0h0.019c0.005 0 0.011 0 0.018 0 3.157 0 6.086 0.976 8.501 2.642l-0.050-0.033c-0.478-0.272-1.051-0.433-1.662-0.433-0.085 0-0.169 0.003-0.252 0.009l0.011-0.001c-2.459 0.336-4.677 1.13-6.648 2.297l0.082-0.045zM5.554 5.268c-0.041 0.014-0.077 0.032-0.11 0.054l0.002-0.001c-2.758 2.723-4.466 6.504-4.466 10.684 0 3.584 1.256 6.875 3.353 9.457l-0.022-0.028c-1.754-3.261 4.48-12.455 7.61-16.159-3.53-3.521-5.277-4.062-6.015-4.062-0.010-0-0.021-0.001-0.032-0.001-0.115 0-0.225 0.021-0.326 0.060l0.006-0.002zM20.083 9.275c3.129 3.706 9.367 12.908 7.605 16.161 2.075-2.554 3.332-5.845 3.332-9.43 0-4.181-1.709-7.962-4.467-10.684l-0.002-0.002c-0.029-0.021-0.063-0.039-0.1-0.052l-0.003-0.001c-0.1-0.036-0.216-0.056-0.336-0.056-0.005 0-0.011 0-0.016 0h0.001c-0.741-0-2.485 0.543-6.014 4.063zM6.114 27.306c2.627 2.306 6.093 3.714 9.888 3.714s7.261-1.407 9.905-3.728l-0.017 0.015c2.349-2.393-5.402-10.901-9.89-14.29-4.483 3.39-12.24 11.897-9.886 14.29z"
                                                      Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                      Width="8" Height="8" Stretch="Uniform"
                                                      VerticalAlignment="Center" Opacity="0.7">
                                                    <Path.Style>
                                                        <Style TargetType="Path">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding ControllerType}" Value="Xbox360">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Path.Style>
                                                </Path>
                                                <!-- DS4 icon -->
                                                <Path Data="M3.262 24.248c-2.374-0.681-2.767-2.084-1.69-2.899 0.776-0.51 1.668-0.954 2.612-1.288l0.087-0.027 7.017-2.516v2.89l-5.030 1.839c-0.881 0.339-1.031 0.79-0.299 1.032 0.365 0.093 0.783 0.147 1.214 0.147 0.615 0 1.204-0.109 1.749-0.308l-0.035 0.011 2.422-0.882v2.592c-0.15 0.037-0.32 0.055-0.487 0.091-0.775 0.136-1.667 0.214-2.577 0.214-1.778 0-3.486-0.298-5.078-0.846l0.110 0.033zM18.049 24.544l7.868-2.843c0.893-0.322 1.032-0.781 0.307-1.022-0.363-0.089-0.779-0.14-1.208-0.14-0.622 0-1.22 0.108-1.774 0.305l0.037-0.011-5.255 1.874v-2.983l0.3-0.106c1.050-0.349 2.284-0.62 3.557-0.761l0.083-0.008c0.468-0.050 1.010-0.078 1.559-0.078 1.877 0 3.677 0.331 5.343 0.939l-0.108-0.035c2.309 0.751 2.549 1.839 1.969 2.589-0.559 0.557-1.235 0.998-1.988 1.282l-0.039 0.013-10.677 3.883v-2.869zM12.231 4.248v21.927l4.892 1.576v-18.39c0-0.862 0.38-1.438 0.992-1.238 0.795 0.225 0.95 1.017 0.95 1.881v7.342c3.050 1.491 5.451-0.003 5.451-3.939 0-4.045-1.407-5.842-5.546-7.282-1.785-0.648-4.040-1.294-6.347-1.805l-0.389-0.072z"
                                                      Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                      Width="8" Height="8" Stretch="Uniform"
                                                      VerticalAlignment="Center" Opacity="0.7">
                                                    <Path.Style>
                                                        <Style TargetType="Path">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding ControllerType}" Value="DualShock4">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Path.Style>
                                                </Path>
                                                <!-- vJoy icon -->
                                                <Path Data="M11.915 15H13V9.874A4.002 4.002 0 0 1 14 2a4 4 0 0 1 1 7.874V15h2a3 3 0 0 1 3 3v4H4v-4a3 3 0 0 1 3-3h.085A1.5 1.5 0 0 1 8.5 14h2a1.5 1.5 0 0 1 1.415 1z"
                                                      Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                      Width="8" Height="8" Stretch="Uniform"
                                                      VerticalAlignment="Center" Opacity="0.7">
                                                    <Path.Style>
                                                        <Style TargetType="Path">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding ControllerType}" Value="VJoy">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Path.Style>
                                                </Path>
                                                <TextBlock Text="{Binding TypeInstanceNumber}" FontSize="10"
                                                           VerticalAlignment="Center" Margin="2,0,0,0"/>
                                            </StackPanel>
                                        </ToggleButton>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <Button Content="Remove" Padding="8,3" Margin="5,0,0,3"
                                    Command="{Binding RemoveDeviceCommand}"
                                    ToolTip="Remove this device and its settings"/>
                        </WrapPanel>

                        <Separator Margin="0,2,0,8"/>

                        <!-- ─── Raw Input State (Visual) ─── -->
                        <TextBlock Text="Raw Input State" FontWeight="SemiBold"
                                   FontSize="13" Margin="0,0,0,8"/>

                        <!-- Axes: progress bars -->
                        <TextBlock Text="Axes" FontSize="11" Opacity="0.6" Margin="0,0,0,3"
                                   Visibility="{Binding HasRawData, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        <ItemsControl ItemsSource="{Binding RawAxes}" Margin="0,0,0,8">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="48"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="44"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{Binding Name}" FontSize="10" Opacity="0.55"
                                                   VerticalAlignment="Center"/>
                                        <ProgressBar Grid.Column="1" Minimum="0" Maximum="1"
                                                     Value="{Binding NormalizedValue, Mode=OneWay}"
                                                     Height="8" Margin="4,0"/>
                                        <TextBlock Grid.Column="2" FontSize="9" Opacity="0.45"
                                                   FontFamily="Consolas" VerticalAlignment="Center"
                                                   HorizontalAlignment="Right"
                                                   Text="{Binding RawValue}"/>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Buttons: circle grid -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,3"
                                    Visibility="{Binding HasRawData, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="Buttons" FontSize="11" Opacity="0.6"/>
                            <TextBlock FontSize="10" Opacity="0.4" Margin="6,0,0,0"
                                       VerticalAlignment="Center">
                                <Run Text="("/>
                                <Run Text="{Binding SelectedButtonTotal, Mode=OneWay}"/>
                                <Run Text="total)"/>
                            </TextBlock>
                        </StackPanel>
                        <ItemsControl ItemsSource="{Binding RawButtons}" Margin="0,0,0,8">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Width="24" Height="24" CornerRadius="12" Margin="1"
                                            ToolTip="{Binding Index, StringFormat='Button {0}'}">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="#28888888"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsPressed}" Value="True">
                                                        <Setter Property="Background" Value="{DynamicResource SystemControlHighlightAccentBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <TextBlock Text="{Binding Index}" FontSize="8"
                                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                                   Opacity="0.7"/>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- POV Hats: compass indicators -->
                        <TextBlock Text="D-Pad / POV" FontSize="11" Opacity="0.6"
                                   Margin="0,0,0,3">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RawPovs.Count}" Value="0">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <ItemsControl ItemsSource="{Binding RawPovs}" Margin="0,0,0,8">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,12,0">
                                        <Canvas Width="36" Height="36">
                                            <!-- Background circle -->
                                            <Ellipse Width="36" Height="36"
                                                     Fill="#18888888" Stroke="#30888888"
                                                     StrokeThickness="1"/>
                                            <!-- Center dot -->
                                            <Ellipse Width="4" Height="4" Canvas.Left="16" Canvas.Top="16"
                                                     Fill="#50888888"/>
                                            <!-- Direction indicator line -->
                                            <Line X1="18" Y1="18" X2="18" Y2="5"
                                                  Stroke="{DynamicResource SystemControlHighlightAccentBrush}"
                                                  StrokeThickness="2.5" StrokeEndLineCap="Round">
                                                <Line.Style>
                                                    <Style TargetType="Line">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsCentered}" Value="True">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Line.Style>
                                                <Line.RenderTransform>
                                                    <RotateTransform Angle="{Binding AngleDegrees}"
                                                                     CenterX="18" CenterY="18"/>
                                                </Line.RenderTransform>
                                            </Line>
                                        </Canvas>
                                        <TextBlock VerticalAlignment="Center" Margin="6,0,0,0"
                                                   FontSize="10" Opacity="0.5">
                                            <Run Text="POV"/>
                                            <Run Text="{Binding Index, Mode=OneWay}"/>
                                        </TextBlock>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Gyroscope -->
                        <TextBlock Text="Gyroscope" FontSize="11" Opacity="0.6" Margin="0,0,0,3"
                                   Visibility="{Binding HasGyroData, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        <Border Visibility="{Binding HasGyroData, Converter={StaticResource BoolToVisibilityConverter}}"
                                Background="#10888888" CornerRadius="6" Padding="10,6" Margin="0,0,0,8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel>
                                    <TextBlock Text="X" FontSize="10" Opacity="0.5" HorizontalAlignment="Center"/>
                                    <TextBlock FontSize="11" FontFamily="Consolas" HorizontalAlignment="Center"
                                               Text="{Binding GyroX, StringFormat='{}{0:F3}'}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Y" FontSize="10" Opacity="0.5" HorizontalAlignment="Center"/>
                                    <TextBlock FontSize="11" FontFamily="Consolas" HorizontalAlignment="Center"
                                               Text="{Binding GyroY, StringFormat='{}{0:F3}'}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Z" FontSize="10" Opacity="0.5" HorizontalAlignment="Center"/>
                                    <TextBlock FontSize="11" FontFamily="Consolas" HorizontalAlignment="Center"
                                               Text="{Binding GyroZ, StringFormat='{}{0:F3}'}"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- Accelerometer -->
                        <TextBlock Text="Accelerometer" FontSize="11" Opacity="0.6" Margin="0,0,0,3"
                                   Visibility="{Binding HasAccelData, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        <Border Visibility="{Binding HasAccelData, Converter={StaticResource BoolToVisibilityConverter}}"
                                Background="#10888888" CornerRadius="6" Padding="10,6" Margin="0,0,0,8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel>
                                    <TextBlock Text="X" FontSize="10" Opacity="0.5" HorizontalAlignment="Center"/>
                                    <TextBlock FontSize="11" FontFamily="Consolas" HorizontalAlignment="Center"
                                               Text="{Binding AccelX, StringFormat='{}{0:F3}'}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Y" FontSize="10" Opacity="0.5" HorizontalAlignment="Center"/>
                                    <TextBlock FontSize="11" FontFamily="Consolas" HorizontalAlignment="Center"
                                               Text="{Binding AccelY, StringFormat='{}{0:F3}'}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Z" FontSize="10" Opacity="0.5" HorizontalAlignment="Center"/>
                                    <TextBlock FontSize="11" FontFamily="Consolas" HorizontalAlignment="Center"
                                               Text="{Binding AccelZ, StringFormat='{}{0:F3}'}"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
    </Grid>
</UserControl>
